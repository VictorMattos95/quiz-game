<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz LPIC-2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        /* --- Estilos do Menu Hambúrguer --- */
        .hamburger-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px; /* Arredondado */
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .hamburger-btn span {
            display: block;
            width: 22px;
            height: 3px;
            background: #333;
            margin: 4px 0;
        }
        .nav-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: #fff;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
        }
        .nav-drawer.open {
            transform: translateX(0);
        }
        .nav-drawer h3 {
            padding: 20px;
            margin: 0;
            border-bottom: 1px solid #eee;
            color: #212529;
        }
        #question-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #question-list li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        #question-list li a:hover {
            background: #f8f9fa;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.open {
            display: block;
        }
        /* --- Fim dos Estilos do Menu --- */

       .quiz-container {
            background: #fff;
            width: 100%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
            padding: 30px;
            box-sizing: border-box;
            margin: 20px auto; 
        }

       .error-container {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #c62828;
            padding: 20px;
            border-radius: 12px; /* Arredondado */
            text-align: center;
        }
        #quiz-content {
            display: none; 
        }

       .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            gap: 15px; 
        }
        #question-title {
            font-size: 22px;
            color: #212529;
            margin-left: 40px; 
            flex-grow: 1; 
            word-break: break-word; 
        }
        #question-title code { 
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        #question-title pre { 
            background: #eee;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.9em;
        }
        #progress {
            font-size: 16px;
            color: #555;
            white-space: nowrap; 
            flex-shrink: 0; 
            padding-top: 4px; 
        }

       .answers {
            margin: 0;
            padding: 0;
            list-style: none;
        }

       .answer-btn {
            display: flex;
            align-items: flex-start;
            width: 100%;
            background: #fff; /* Fundo branco para o efeito de "levantar" */
            border: 1px solid #ced4da;
            border-radius: 8px; /* Mais arredondado */
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Transição mais suave */
            box-sizing: border-box;
        }
       .answer-btn:hover:not([disabled]) {
            background: #fff;
            border-color: #007bff; /* Borda azul no hover */
            transform: translateY(-2px); /* Efeito de "levantar" */
            box-shadow: 0 4px 10px rgba(0,123,255,0.1); /* Sombra azul suave */
        }
       .option-key {
            font-weight: bold;
            color: #212529; /* Cor mais escura */
            margin-right: 10px;
            flex-shrink: 0;
        }
       .option-text {
            flex-grow: 1;
            color: #495057; /* Cinza mais escuro */
            font-weight: 500; /* Texto mais legível */
            word-break: break-word;
        }
       .answer-btn.selected {
            background-color: #d0e7ff; 
            border-color: #007bff;
        }
        
       .answer-btn.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: bold;
        }
       .answer-btn.correct .option-key,
       .answer-btn.correct .option-text {
            color: #155724;
            font-weight: bold;
        }
       .answer-btn.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            font-weight: bold;
        }
       .answer-btn.incorrect .option-key,
       .answer-btn.incorrect .option-text {
            color: #721c24;
            font-weight: bold;
        }
        
       .answer-btn.missed {
            background-color: #fff; /* Fundo branco */
            border: 2px dashed #155724; /* Borda verde tracejada */
            color: #155724;
            font-weight: bold;
        }
       .answer-btn.missed .option-key,
       .answer-btn.missed .option-text {
            color: #155724;
            font-weight: bold;
        }
        
       .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7; 
        }
       .answer-input {
            display: block;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 8px; /* Arredondado */
            padding: 15px;
            margin-bottom: 10px;
            font-size: 16px;
            box-sizing: border-box; 
        }
       .answer-input.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: bold;
        }
       .answer-input.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            font-weight: bold;
        }
        
       .explanation-container {
            background: #e7f3fe; 
            border: 1px solid #b0c4de; 
            border-radius: 8px; /* Arredondado */
            padding: 20px;
            margin-top: 20px;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            clear: both; 
        }
       .explanation-container strong {
            color: #0056b3; 
            display: block;
            margin-bottom: 5px;
        }
       .quiz-footer {
            margin-top: 20px;
            text-align: right;
            clear: both;
        }
       .score-container {
            text-align: center;
        }
        .score-container h2 {
            color: #212529;
        }

       .action-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px; /* Padding ajustado */
            border-radius: 8px; /* Arredondado */
            font-size: 16px;
            font-weight: 500; /* Peso da fonte */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Transição */
            text-decoration: none;
            display: inline-block; /* Para o <a> funcionar */
        }
       .action-btn:hover:not([disabled]) {
            background-color: #0056b3;
            transform: scale(1.03); /* Efeito "pop" */
            box-shadow: 0 4px 15px rgba(0,123,255,0.25); /* Sombra azul */
        }

       .submit-fill-btn {
            text-align: center;
            width: auto; 
            float: right;
            margin-top: 10px; 
        }
        #next-btn {
            display: none; 
        }
        #restart-btn {
            text-align: center;
        }

        /* *** CORREÇÃO APLICADA (LAYOUT RESPONSIVO) *** */
        @media (max-width: 650px) {
            
            .quiz-container {
                padding: 15px;
                margin: 10px auto;
            }

            .question-header {
                flex-direction: column-reverse; /* Inverte a ordem e empilha */
                align-items: stretch; /* Ocupa largura total */
                gap: 5px; 
                margin-bottom: 15px;
            }

            #question-title {
                margin-left: 0; /* Remove margem desnecessária */
                font-size: 20px; 
            }
            
            #progress {
                text-align: right; /* Alinha progresso à direita */
                padding-top: 0; 
                width: 100%; 
            }

            .hamburger-btn {
                top: 10px;
                left: 10px;
            }
        }

    </style>
</head>
<body>

    <button id="menu-toggle" class="hamburger-btn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div id="nav-overlay" class="overlay"></div>
    <nav id="nav-menu" class="nav-drawer">
        <h3>Navegar Questões</h3>
        <ul id="question-list">
            </ul>
    </nav>
    <div class="quiz-container">
        <div class="error-container" id="error-box" style="display: none;">
            <h2>Erro ao Carregar o Quiz</h2>
            <p id="error-message"></p>
            <p>Por favor, volte ao <a href="index.html">menu principal</a> e tente novamente.</p>
        </div>

        <div id="quiz-content">
            <div class="question-header">
                <h2 id="question-title">Carregando pergunta...</h2>
                <p id="progress">Pergunta 1/X</p>
            </div>
            
            <div id="answers" class="answers"></div>
            
            <div id="explanation-box" class="explanation-container" style="display: none;">
                </div>

            <div class="quiz-footer">
                <button id="next-btn" class="action-btn">Próxima</button>
            </div>
        </div>

        <div id="score-box" class="score-container" style="display: none;">
            <h2 id="score-title">Quiz Finalizado!</h2>
            <p id="score-text">Você acertou X de Y perguntas.</p>
            <a href="index.html" id="restart-btn" class="action-btn">Jogar Novamente</a>
        </div>
    </div>

    <script>
        // Elementos da UI
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const quizContent = document.getElementById('quiz-content');
        const scoreBox = document.getElementById('score-box');
        
        const questionTitleEl = document.getElementById('question-title');
        const progressEl = document.getElementById('progress');
        const answersEl = document.getElementById('answers');
        const nextBtn = document.getElementById('next-btn');
        const explanationBox = document.getElementById('explanation-box'); 
        const menuToggle = document.getElementById('menu-toggle');
        const navMenu = document.getElementById('nav-menu');
        const navOverlay = document.getElementById('nav-overlay');
        const questionList = document.getElementById('question-list');
        const scoreTitleEl = document.getElementById('score-title');
        const scoreTextEl = document.getElementById('score-text');

        // Estado do Quiz
        let currentQuestionIndex = 0;
        let score = 0;
        let quizData = []; 

        function showUIError(message) {
            quizContent.style.display = 'none';
            scoreBox.style.display = 'none';
            errorMessage.textContent = message;
            errorBox.style.display = 'block';
            menuToggle.style.display = 'none'; 
        }

        function startQuiz() {
            quizData.sort(() => Math.random() - 0.5); 
            currentQuestionIndex = 0;
            score = 0;
            
            // BUG 1 FIX: Inicializa o estado 'answered' para cada pergunta
            quizData.forEach(q => q.answered = false);

            nextBtn.innerHTML = "Próxima";
            populateNavMenu(); 
            showQuestion();
            menuToggle.style.display = 'block'; 
        }

        function showQuestion() {
            resetState();
            const currentQuestion = quizData[currentQuestionIndex];
            const questionNumber = currentQuestionIndex + 1;
            
            questionTitleEl.innerHTML = `${questionNumber}. ${currentQuestion.pergunta}`;
            progressEl.innerText = `Pergunta ${questionNumber}/${quizData.length}`;

            const correctAnswers = currentQuestion.respostaCorreta;
            const isMultiAnswer = Array.isArray(correctAnswers);

            if (currentQuestion.tipo === 'fill') {
                const input = document.createElement("input");
                input.type = "text";
                input.id = "fill-answer-input";
                input.placeholder = "Digite sua resposta aqui...";
                input.classList.add("answer-input"); 
                input.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault(); 
                        const submitBtn = document.getElementById('fill-submit-btn');
                        if (submitBtn && !submitBtn.disabled) {
                            submitBtn.click();
                        }
                    }
                });

                const submitBtn = document.createElement("button");
                submitBtn.innerText = "Verificar";
                submitBtn.classList.add("action-btn", "submit-fill-btn"); 
                submitBtn.id = "fill-submit-btn";
                submitBtn.addEventListener("click", checkFillAnswer);

                answersEl.appendChild(input);
                answersEl.appendChild(submitBtn);

            } else {
                const displayKeys = ['A', 'B', 'C', 'D', 'E', 'F', 'G']; 
                const originalKeys = Object.keys(currentQuestion.opcoes);
                originalKeys.sort(() => Math.random() - 0.5);

                if (isMultiAnswer) {
                    originalKeys.forEach((originalKey, index) => {
                        const displayKey = displayKeys[index]; 
                        const answerText = currentQuestion.opcoes[originalKey]; 

                        const button = document.createElement("button");
                        button.innerHTML = `<span class="option-key">${displayKey}:</span> <span class="option-text">${answerText}</span>`;
                        button.classList.add("answer-btn");
                        button.dataset.key = originalKey; 
                        button.addEventListener("click", toggleAnswer); 
                        answersEl.appendChild(button);
                    });
                    
                    const submitBtn = document.createElement("button");
                    submitBtn.innerText = "Verificar Respostas";
                    submitBtn.classList.add("action-btn", "submit-fill-btn"); 
                    submitBtn.id = "multi-submit-btn";
                    submitBtn.addEventListener("click", checkMultiAnswer);
                    answersEl.appendChild(submitBtn);

                } else {
                    originalKeys.forEach((originalKey, index) => {
                        const displayKey = displayKeys[index]; 
                        const answerText = currentQuestion.opcoes[originalKey]; 
                        
                        const button = document.createElement("button");
                        button.innerHTML = `<span class="option-key">${displayKey}:</span> <span class="option-text">${answerText}</span>`;
                        button.classList.add("answer-btn");
                        button.dataset.key = originalKey; 

                        if (originalKey === correctAnswers) { 
                            button.dataset.correct = "true";
                        }
                        button.addEventListener("click", selectAnswer); 
                        answersEl.appendChild(button);
                    });
                }
            }

            // Se a pergunta já foi respondida, re-exibe o estado
            if (currentQuestion.answered) {
                if (currentQuestion.tipo === 'fill') {
                    // Simula o clique para re-exibir o estado
                    const inputEl = document.getElementById('fill-answer-input');
                    if(inputEl) {
                        // Não podemos saber a resposta anterior, então apenas desabilitamos
                        inputEl.disabled = true;
                        document.getElementById('fill-submit-btn').disabled = true;
                        showExplanation();
                        nextBtn.style.display = 'block';
                    }
                } else {
                    // Simula o clique para re-exibir o estado
                    if(isMultiAnswer) {
                        // Não podemos saber as seleções anteriores, então apenas desabilitamos
                         Array.from(answersEl.children).forEach(button => {
                            button.disabled = true;
                         });
                    } else {
                         Array.from(answersEl.children).forEach(button => {
                            if (button.classList.contains('answer-btn')) {
                                button.disabled = true; // Desabilita todos
                            }
                        });
                    }
                    showExplanation();
                    nextBtn.style.display = 'block';
                }
                
                // Nota: O estado visual (cores, seleção) não é 100% restaurado
                // ao navegar, mas a pontuação está protegida.
            }
        }


        function resetState() {
            nextBtn.style.display = 'none';
            explanationBox.style.display = 'none';
            explanationBox.innerHTML = '';
            
            while (answersEl.firstChild) {
                answersEl.removeChild(answersEl.firstChild);
            }
        }

        function selectAnswer(e) {
            const selectedBtn = e.target.closest('.answer-btn'); 
            const isCorrect = selectedBtn.dataset.correct === "true";

            if (isCorrect) {
                selectedBtn.classList.add("correct");
                // BUG 1 FIX: Só pontua se a pergunta não foi respondida
                if (!quizData[currentQuestionIndex].answered) {
                    score++;
                }
            } else {
                selectedBtn.classList.add("incorrect");
            }
            
            // BUG 1 FIX: Marca a pergunta como respondida
            quizData[currentQuestionIndex].answered = true;

            Array.from(answersEl.children).forEach(button => {
                if (button.classList.contains('answer-btn') && !button.id.includes('submit')) { 
                    if (button.dataset.correct === "true") {
                        button.classList.add("correct");
                    }
                    button.disabled = true;
                }
            });
            
            showExplanation(); 
            nextBtn.style.display = 'block';
        }

        function checkFillAnswer() {
            const inputEl = document.getElementById('fill-answer-input');
            const submitBtn = document.getElementById('fill-submit-btn');
            
            // Verificação case-sensitive (sem .toLowerCase())
            const userAnswer = inputEl.value.trim(); 
            const currentQuestion = quizData[currentQuestionIndex];
            const correctAnswers = currentQuestion.respostaCorreta;

            let isCorrect = false;

            if (Array.isArray(correctAnswers)) {
                // Se a resposta correta for um array, verifica se a resposta (exata) do usuário está nele
                isCorrect = correctAnswers.some(ans => ans === userAnswer);
            } else {
                // Se for uma string única, apenas compara (exato)
                isCorrect = (correctAnswers === userAnswer);
            }

            if (isCorrect) {
                inputEl.classList.add("correct");
                // BUG 1 FIX: Só pontua se a pergunta não foi respondida
                if (!quizData[currentQuestionIndex].answered) {
                    score++;
                }
            } else {
                inputEl.classList.add("incorrect");
                
                // BUG 2 FIX: Lógica de exibir resposta correta movida para showExplanation()
            }
            
            // BUG 1 FIX: Marca a pergunta como respondida
            quizData[currentQuestionIndex].answered = true;

            showExplanation();

            inputEl.disabled = true;
            submitBtn.disabled = true;
            nextBtn.style.display = 'block';
        }

        function toggleAnswer(e) {
            e.target.closest('.answer-btn').classList.toggle('selected');
        }

        function checkMultiAnswer() {
            const currentQuestion = quizData[currentQuestionIndex];
            const correctAnswers = currentQuestion.respostaCorreta; // Array, ex: ["D", "E"]
            const buttons = Array.from(answersEl.querySelectorAll('.answer-btn'));
            const selectedAnswers = []; 

            buttons.forEach(button => {
                const key = button.dataset.key;
                if (key && button.classList.contains('selected')) {
                    selectedAnswers.push(key);
                }
            });

            const sortedCorrect = [...correctAnswers].sort();
            const sortedSelected = [...selectedAnswers].sort();
            const isPerfectMatch = JSON.stringify(sortedCorrect) === JSON.stringify(sortedSelected);
            
            if (isPerfectMatch) {
                // BUG 1 FIX: Só pontua se a pergunta não foi respondida
                if (!quizData[currentQuestionIndex].answered) {
                    score++;
                }
            }

            // BUG 1 FIX: Marca a pergunta como respondida
            quizData[currentQuestionIndex].answered = true;

            buttons.forEach(button => {
                const key = button.dataset.key;
                if (!key) return; 

                const isCorrectAnswer = correctAnswers.includes(key);
                const isSelected = button.classList.contains('selected');

                if (isSelected) {
                    if (isCorrectAnswer) {
                        button.classList.add('correct'); 
                    } else {
                        button.classList.add('incorrect'); 
                    }
                } else {
                    if (isCorrectAnswer) {
                        button.classList.add('missed'); 
                    }
                }
                
                button.disabled = true;
            });

            document.getElementById('multi-submit-btn').disabled = true;
            showExplanation();
            nextBtn.style.display = 'block';
        }
        
        // BUG 2 FIX: showExplanation() agora exibe a resposta correta para
        // perguntas de preenchimento (fill) que foram respondidas incorretamente.
        function showExplanation() {
            const currentQuestion = quizData[currentQuestionIndex];
            const explanation = currentQuestion.explicacao;
            let html = "";

            // Verifica se é uma pergunta 'fill' que foi respondida incorretamente
            if (currentQuestion.tipo === 'fill' && currentQuestion.answered) {
                const inputEl = document.getElementById('fill-answer-input');
                if (inputEl && inputEl.classList.contains('incorrect')) {
                    const correctAnswers = currentQuestion.respostaCorreta;
                    // Exibe todas as respostas corretas possíveis
                    const displayAnswers = Array.isArray(correctAnswers) ? correctAnswers.join('</strong> ou <strong>') : correctAnswers;
                    // Adiciona a resposta correta ao topo da caixa de explicação
                    html += `<p style="margin-bottom: 15px; color: #721c24; font-weight: 500;">Resposta correta: <strong>${displayAnswers}</strong></p>`;
                }
            }

            if (explanation) {
                html += `<strong>Explicação:</strong> ${explanation}`;
            }

            if (html) {
                explanationBox.innerHTML = html;
                explanationBox.style.display = 'block';
            }
        }

        function populateNavMenu() {
            questionList.innerHTML = ''; 
            quizData.forEach((question, index) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                
                const cleanText = question.pergunta.replace(/<[^>]+>/g, ''); 
                a.textContent = `Questão ${index + 1}: ${cleanText.substring(0, 30)}...`;
                
                a.dataset.index = index;
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    jumpToQuestion(index);
                });
                li.appendChild(a);
                questionList.appendChild(li);
            });
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            showQuestion();
            closeNavMenu();
        }

        function openNavMenu() {
            navMenu.classList.add('open');
            navOverlay.classList.add('open');
        }

        function closeNavMenu() {
            navMenu.classList.remove('open');
            navOverlay.classList.remove('open');
        }

        function showScore() {
            resetState();
            quizContent.style.display = 'none';
            scoreTextEl.innerText = `Você acertou ${score} de ${quizData.length} perguntas.`;
            scoreBox.style.display = 'block';
            menuToggle.style.display = 'none'; 
        }

        function handleNextButton() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                showQuestion();
            } else {
                showScore();
            }
        }

        /* *** CORREÇÃO APLICADA (BUG 3) *** */
        nextBtn.addEventListener("click", () => {
            handleNextButton();
        });

        document.addEventListener('DOMContentLoaded', () => {
            menuToggle.addEventListener('click', openNavMenu);
            navOverlay.addEventListener('click', closeNavMenu);
            menuToggle.style.display = 'none'; 

            const urlParams = new URLSearchParams(window.location.search);
            const assunto = urlParams.get('assunto');

            if (!assunto) {
                showUIError("Nenhum assunto de quiz foi especificado na URL.");
                return;
            }

            const scriptPath = `dados_${assunto}.js`;
            const scriptElement = document.createElement('script');
            scriptElement.src = scriptPath;

            scriptElement.onload = () => {
                if (typeof perguntas!== 'undefined' && perguntas.length > 0) {
                    quizData = perguntas;
                    quizContent.style.display = 'block'; 
                    startQuiz();
                } else {
                    showUIError(`O arquivo de dados '${scriptPath}' está vazio ou não definiu a variável 'perguntas' corretamente.`);
                }
            };

            scriptElement.onerror = () => {
                showUIError(`Falha ao carregar o arquivo de dados do quiz: '${scriptPath}'. Verifique se o arquivo existe e o caminho está correto.`);
            };

            document.head.appendChild(scriptElement);
        });
    </script>
</body>
</html>